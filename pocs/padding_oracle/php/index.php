<html>
<head>
    <title>Moo.</title>
</head>
<body>
<h1>Welcome!</h1>
<?php
 
define('MY_AES_IV', "0000000000000000");
define('MY_AES_KEY', "0123456701234567");
//define('MY_HMAC_KEY', CENSORED);
 
function aes($data, $encrypt) {
    $aes = mcrypt_module_open(MCRYPT_RIJNDAEL_128, '', MCRYPT_MODE_CBC, '');
    mcrypt_generic_init($aes, MY_AES_KEY, MY_AES_IV);
    return $encrypt ? mcrypt_generic($aes, $data) : mdecrypt_generic($aes, $data);
}
 /*
define('MY_MAC_LEN', 40);
 
function hmac($data) {
    return hash_hmac('sha1', data, MY_HMAC_KEY);
}*/
 
function encrypt($data) {
    return aes($data /*. hmac($data)*/, true);
}
 
function decrypt($data) {
    $data = rtrim(aes($data, false), "\0");/*
    $mac = substr($data, -MY_MAC_LEN);
    $data = substr($data, 0, -MY_MAC_LEN);*/
    return $data; //hmac($data) === $mac ? $data : null;
}
 
$settings = array();
if (@$_COOKIE['settings']) {
    $settings = @unserialize(@decrypt(base64_decode($_COOKIE['settings'])));
} 
 
if (@$_POST['name'] && is_string($_POST['name']) && strlen($_POST['name']) < 200) {
    $settings = array(
            'name' => $_POST['name'], 
            'greeting' => ('cowsay ' . escapeshellarg("Hello {$_POST['name']}!")),
    );
    setcookie('settings', base64_encode(@encrypt(serialize($settings))));
}
 
if (@$settings['greeting']) {
    echo "<pre>\n";
    passthru($settings['greeting']);
    echo "</pre>\n";
} else {
    echo "<form action=\"?\" method=\"POST\">\n";
    echo "<p>What is your name?</p>\n";
    echo "<input type=\"text\" name=\"name\" />\n";
    echo "<input type=\"submit\" name=\"submit\" value=\"Submit\" />\n";
    echo "</form>\n";
}
 
?>
</body>
</html>
