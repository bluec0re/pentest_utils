{% extends "base.html" %}

{% block header %}
<script type="text/javascript">
// <![CDATA[
var callbacks = {};

(function($) {
    jQuery.fn.ajaxify = function(success, error) {
        $(this).submit(function() {
            try {
                var action = this.action || location.href;
                var settings = {
                    url : action,
                    type : this.method,
                    async : true,
                    //success : success,
                    error : error,
                    data : $(this).serialize()
                };
                if(success) {
                    var request_id = Math.random();
                    settings.data += '&req_id=' + request_id;
                    callbacks[request_id] = success;
                }
                $.ajax(settings);
            } catch(e) {}
            return false;
        });
    };
}(jQuery));

function load_clients(clients) {
    $("#client_list").html("");

    var found = false;

    $(clients).each(function(idx, item) {
            if(item.id == $("#content").attr("data-client"))
                found = true;
            $("#client_list").append(
                $("<li/>").append(
                    $("<a/>").text(item.ip + " (" + item.ua + ")")
                             .attr("href", "/client/" + item.id)
                             .append($("<i class=\"icon-chevron-right\"></i>"))
                             .click(function() {
                                 $("#content").load("/client/" + item.id);
                                 $("#content").attr('data-client', item.id);
                                 return false;
                             })
                )
            );
    });

    if(!found)
        $("#content").attr("data-client", null).html("");
}

$(document).ready(function() {
    var socket = new WebSocket("ws://" + location.host + "/serversocket");
    socket.onmessage = function(event) {
        var data = $.parseJSON(event.data);
        console.log(data);

        if(data.command == 'client_list') {
            load_clients(data.data);
        } else if(data.command == 'callback') {
            if(callbacks[data.req_id]) {
                callbacks[data.req_id].apply(socket, data.data);
                delete callbacks[data.req_id];
            }
        }
    };
    socket.onclose = function() {
        $("#no_connection").show('slide-down');
        $("#content").html("");
    };
    socket.onopen = function() {
        $("#no_connection").hide('slide-up');
    };
});
// ]]>
</script>
{% end %}

{% block body %}
<div class="alert alert-error" id="no_connection">
    <h4>No Connection</h4>
    No connection to the server. Please reload.
</div>
<div id="content">
    <h1>Please select a client</h1>
</div>
{% end %}

{% block sidebar %}
<ul class="nav nav-list" id="client_list">
</ul>
{% end %}
